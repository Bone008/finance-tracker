name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Compile protocol buffers
      run: npm run protoc
    
    - name: Build Angular app
      run: npm run build -- --prod

    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: dist
        path: dist/
    
    - name: Deploy to server
      uses: wlixcc/SFTP-Deploy-Action@a5ccb9c6211a94cc59404f0fdb2a9936a6dfee64
      with:
        username: ${{ secrets.DEPLOY_SSH_USER }}
        server: ${{ secrets.DEPLOY_SSH_HOST }}
        port: 22
        local_path: './dist/*'
        remote_path: ${{ secrets.DEPLOY_TARGET_DIR }}
        sftp_key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
