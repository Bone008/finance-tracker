<mat-card class="main-card">
  <mat-card-title fxLayout="row" fxLayoutGap="10px">
    <span fxFlex>Transactions</span>
    <button
        (click)="startImportCsv()"
        mat-fab
        matTooltip="Import CSV">
        <mat-icon>attachment</mat-icon>
    </button>
    <button
        (click)="startAddTransaction()"
        mat-fab
        matTooltip="Add transaction">
        <mat-icon>add</mat-icon>
    </button>
  </mat-card-title>

  <mat-card-content>
    <mat-form-field class="filter-input">
      <input matInput type="search" [(ngModel)]="filterInput" placeholder="Filter">
      <button
          mat-icon-button
          matSuffix
          title="Clear filter"
          *ngIf="filterInput!==''"
          (click)="clearFilter()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    
    <div class="transactions-container">
      <div class="header-row" fxLayout="row" fxLayoutGap="5px">
        <mat-checkbox
            (change)="$event ? masterToggle() : null"
            [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()">
        </mat-checkbox>
        <span fxFlex></span>
        <div
            *ngIf="getSelectionSummary() as summary"
            fxLayout="row wrap" fxLayoutAlign="center" fxLayoutGap="12px"
            class="mat-caption selection-summary">
          <span *ngIf="!summary.datesAreSame">{{summary.dateFirst | date}} - {{summary.dateLast | date}}</span>
          <span>{{summary.diffDays}} days</span>
          <span *ngIf="summary.diffMonths >= 3">{{summary.diffMonths}} months</span>
          <span>
            <span [class.negative]="summary.sum < 0">{{summary.sum | number:'1.2-2'}}&nbsp;€</span>
            <span *ngIf="summary.sumPositive && summary.sumNegative">
              (+{{summary.sumPositive | number:'1.2-2'}}&nbsp;€,
              <span class="negative">{{summary.sumNegative | number:'1.2-2'}}&nbsp;€</span>)
            </span>
          </span>
        </div>
        <span class="mat-caption">{{selection.selected.length}}&nbsp;selected</span>

        <button
            mat-icon-button
            color="primary"
            matTooltip="Edit selected ..."
            [disabled]="selection.selected.length !== 1 || isTransactionGroup(selection.selected[0])"
            (click)="startEditTransaction(selection.selected[0])">
          <mat-icon>edit</mat-icon>
        </button>
        <button
            mat-icon-button
            color="primary"
            matTooltip="Split selected ..."
            [disabled]="selection.selected.length !== 1 || !selection.selected[0].single"
            (click)="startSplitTransaction(selection.selected[0])">
          <mat-icon>call_split</mat-icon>
        </button>
        <button
            mat-icon-button
            color="primary"
            [matTooltip]="getGroupTooltip(selection.selected)"
            [disabled]="!canGroup(selection.selected) && !canUngroup(selection.selected)"
            (click)="groupOrUngroupTransactions(selection.selected)">
          <mat-icon>ballot</mat-icon>
        </button>
        <button
            mat-icon-button
            color="primary"
            matTooltip="Delete selected"
            [disabled]="selection.selected.length === 0"
            (click)="deleteTransactions(selection.selected)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>

      <div
          class="data-row"
          *ngFor="let transaction of (transactionsSubject | async)"
          (click)="$event.stopPropagation(); selection.toggle(transaction)"
          [class.selected]="selection.isSelected(transaction)">
        <mat-checkbox
            class="cell-select"
            (click)="$event.stopPropagation()"
            (change)="$event ? selection.toggle(transaction) : null"
            [checked]="selection.isSelected(transaction)">
        </mat-checkbox>

        <div class="cell-date">
          <span [matTooltip]="getTransactionDate(transaction) | date:'medium'">
            {{getTransactionDate(transaction) | date}}
          </span>
          <span *ngIf="isTransactionGroup(transaction)" class="grouped-comment">
            {{transaction.group.children.length}}&nbsp;grouped
          </span>
        </div>

        <div class="cell-amount" [class.negative]="getTransactionAmount(transaction) < 0">
          <span>{{getTransactionAmount(transaction) | number:'1.2-2'}}&nbsp;€</span>
          <ng-container [ngSwitch]="isTransactionCash(transaction)">
            <mat-icon *ngSwitchCase="true">money</mat-icon>
            <mat-icon *ngSwitchCase="false">assignment</mat-icon>
            <mat-icon *ngSwitchCase="null">list</mat-icon>
          </ng-container>
        </div>

        <div class="cell-notes">
          <div *ngFor="let line of formatTransactionNotes(transaction)">
            <span>{{line[0]}}</span>
            <br *ngIf="line[0] && line[1]">
            <span *ngIf="line[1]" class="notes-comment">{{line[1]}}</span>
          </div>
        </div>

        <div class="cell-labels">
          <app-transaction-labels
              [labels]="transaction.labels"
              (labelClick)="filterByLabel($event.label, $event.shiftKey)"
              (labelAdd)="addLabelToTransaction(transaction, $event)"
              (labelDelete)="deleteLabelFromTransaction(transaction, $event)"
              (labelDeleteLast)="deleteLastLabelFromTransaction(transaction)"
              labelTitle="Click to filter by this label">
          </app-transaction-labels>
        </div>
      </div>
    </div>

    <mat-paginator [pageSizeOptions]="[20, 50, 100]" showFirstLastButtons></mat-paginator>
  </mat-card-content>
</mat-card>
